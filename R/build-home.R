#' Build home page
#'
#' First looks for `index.Rmd` or `README.Rmd`, then
#' `index.md` or `README.md`. If none are found, falls back to the
#' description field in `DESCRIPTION`.
#'
#' @section YAML config:
#' To tweak the home page, you need a section called `home`.
#'
#' The sidebar links are automatically generated by inspecting the
#' `URL` and `BugReports` fields of the `DESCRIPTION`.
#' You can add additional links with a subsection called `links`,
#' which should contain a list of `text` + `href` elements:
#'
#' \preformatted{
#' home:
#'   links:
#'   - text: Link text
#'     href: http://website.com
#' }
#'
#' The "developers" list is populated by the maintainer ("cre"), authors
#' ("aut"), and funder ("fnd").
#'
#' @section Badges:
#' Status badges are displayed in the sidebar under the section "Dev status".
#' This section is automatically populated if the first paragraph of the
#' homepage consists solely of status badges as linked images.
#'
#' @inheritParams build_articles
#' @param preview If `TRUE`, will preview freshly generated home page
#' @export
build_home <- function(pkg = ".", path = "docs", depth = 0L, encoding = "UTF-8",
                       preview = TRUE) {
  rstudio_save_all()
  old <- set_pkgdown_env("true")
  on.exit(set_pkgdown_env(old))

  pkg <- as_pkgdown(pkg)
  path <- rel_path(path, pkg$path)

  rule("Building home")
  scoped_package_context(pkg$package, pkg$topic_index, pkg$article_index)
  scoped_file_context(depth = depth)

  build_home_license(pkg, path)

  # Build authors page
  if (has_citation(pkg$path)) {
    build_citation_authors(pkg, path = path, depth = depth)
  } else {
    build_authors(pkg, path = path, depth = depth)
  }

  build_home_index(pkg, path, depth = depth, encoding = encoding)

  if (preview) {
    utils::browseURL(file.path(path, "index.html"))
  }

  invisible()
}
